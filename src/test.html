<html>
<body>
	<h1 id="open">???</h1>
	<h2 id="prout">prout not connected</h2>
	<table><tr><td><video id="video" width=320px height=240px autoplay></video></td><td>
	<video id="localvideo" width=320px height=240px autoplay></video></td></tr></table>
	<pre id="msg"></pre>
</body>
<script>

const RTCPeerConnection = webkitRTCPeerConnection;

function $(sel) { return document.querySelector(sel); }

var localStream = null;

navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
navigator.getUserMedia({ video: true },
	function(stream) {
		$("#localvideo").src = URL.createObjectURL(stream);
		localStream = stream;
	},
	function(error) {
		console.error('navigator.getUserMedia error: ', error);
	}
);




function start() {
	var ws = new WebSocket("ws://localhost:10000", "webrtc-pp");
	var rtc = null;

	ws.onopen = function() {
		$("#open").innerHTML = "OPEN";
		rtc = new RTCPeerConnection(null);
		if(localStream) rtc.addStream(localStream);


		rtc.onicecandidate = function(e) {
			if(!e.candidate) return;
			$("#msg").innerHTML += "Send Local ICE candidate : " + JSON.stringify(e.candidate) + "\n";
			ws.send(JSON.stringify(e.candidate));
		};

		rtc.oniceconnectionstatechange = function() {};

		rtc.ondatachannel = function(event) {
			var i = 0;
	  		ch = event.channel;
	  		ch.onmessage = function(event){
				var s = String.fromCharCode.apply(null, new Uint8Array(event.data));
				document.querySelector("#prout").innerHTML = s;
				ch.send("non mais tu es fou ! " + (i++));
	  		};
		};

		rtc.onaddstream = function(event) {
			$("#video").src = URL.createObjectURL(event.stream);
		};

	}

	ws.onclose = function() {
		$("#open").innerHTML = "CLOSED";
	}

	ws.onmessage = function(msg) {
		var data = JSON.parse(msg.data);
		if(data.sdp) {
			$("#msg").innerHTML += "Received remote SDP : " + JSON.stringify(data) + "\n";
			rtc.setRemoteDescription(new RTCSessionDescription(data), function(){
				rtc.createAnswer(function(sdp) {
					rtc.setLocalDescription(sdp);
					$("#msg").innerHTML += "Send local SDP  : " + JSON.stringify(sdp) + "\n";
					ws.send(JSON.stringify(sdp));
				}, function() {
					$("#msg").innerHTML += "Can't create local SDP !\n";
				});

			}, function(){
				$("#msg").innerHTML += "Can't set remote SDP !\n";
			});
		} else {
			$("#msg").innerHTML += "Received Remote ICE candidate "+ JSON.stringify(data) +"\n";
			rtc.addIceCandidate(new RTCIceCandidate(data), function() {}, function() {
					$("#msg").innerHTML += "Can't add remote ICE candidate !\n";
				}
			);
		}
	}

}
setTimeout(start, 2000);



</script>
</html>
